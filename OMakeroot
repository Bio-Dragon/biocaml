open build/Common
open ./etc/OCaml

PROJECT = biocaml
OPAM_PACKAGE_NAME = $(PROJECT)
VERSION = dev

PACKAGES(x) =
  switch $(x)
  case unix
    return $(array \
      core ppx_sexp_conv sexplib ppx_compare \
      cfstream future.unix xmlm zip re.perl uri)
  case ez
    return $(PACKAGES unix)
  case async-unix
    return $(PACKAGES unix) async future.async-unix
  case lwt-unix
    return $(PACKAGES unix) lwt future.lwt-unix
  case test
    return $(PACKAGES unix) ounit
  case biocaml_run_tests
    return $(PACKAGES test)
  default
    eprintln(PACKAGES undefined for $(x).)
    exit(1)

LIB_DEPS(x) =
  switch $(x)
  case unix
    return $(EMPTY)
  case ez
    return unix
  case async-unix
    return unix
  case lwt-unix
    return unix
  case test
    return unix
  case biocaml_run_tests
    return unix test
  default
    eprintln(LIB_DEPS undefined for $(x).)
    exit(1)

OCAMLFLAGS = -bin-annot -annot -w A-4-33-41-42-44-45-48 \
             -thread -short-paths -g

MerlinFile()
METAFile()
OpamInstallFile($(EMPTY))
CleanCommands()

.SUBDIRS: .
  foreach(x => ..., $(LIBS))
    OCamlLibrary($(x))

  foreach(x => ..., $(APPS))
    OCamlApp($(x))

.PHONY: run-tests
run-tests: _build/app/biocaml-run-tests.native
  $<
  rm -f $(ROOT)/delme
